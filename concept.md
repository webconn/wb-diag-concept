WirenBoard Diagnostics
======================

В этом документе/обсуждении я хотел бы поговорить об идее нового 
инструментария для сбора и анализа диагностических данных для ПО контроллеров
Wiren Board.

Концепция
=========

Зачем, если есть логи?
----------------------

Самый часто используемый инструмент при отладке проблем на контроллере - это
логи. Из логов можно извлечь информацию о событиях в системе, об изменениях
состояния, которые приводят к проблемам. Логи в первую очередь просят на
форуме при поиске причин неисправностей, после чего опытный специалист
выполняет зачастую механические действия по их анализу и извлекает оттуда
информацию, которая будет полезна пользователю.


Преимущества логов как инструмента отладки и разбора полётов:

 * Логи **просто реализовать**. Отладочный вывод в консоль - это инструмент,
   знакомый каждому программисту. Всякие библиотеки вроде glog, log4cpp, а
   также инструментарии вроде syslog и journald добавляют в процесс написания
   логов лоска и шарма.
 
 * В логах сохраняется **история изменений состояния** системы во времени.
   Это происходит естественным образом и незаменимо при отладке.

 * Логи **легко отчуждаются**. То есть, можно попросить пользователя на
   форуме скинуть логи и проанализировать их вручную. Лог - это текстовый
   файл, и почти все знают, как с ним обращаться.


При всём этом у логов есть куча недостатков:

 * Логи **сложно читать**. Обычно лог - это большой текстовый файл, который
   содержит целую кучу повторяющихся записей. В нынешнем виде для того,
   чтобы извлечь из логов что-то нужное, приходится фильтровать их по ключевым
   словам, что в нашей системе часто делается с помощью `grep` - самый
   недружелюбный инструмент для начинающих и для тех, кто не хочет разбираться
   в Linux ради того, чтобы настроить автоматику. К тому же ключевые слова
   не всегда очевидно извлекаются из логов (см. дальше).

 * Логи **сложно писать**. Если быть точнее - логи сложно писать так, чтобы
   их потом было просто анализировать. В творческом порыве программист
   расставляет записи в лог так, как ему нужно в момент написания кода,
   при этом часть полезной информации неизбежно теряется. К тому же каждый
   программист пишет логи по-своему, что приводит к неконсистентности логов
   между разными фрагментами кода и не позволяет придумывать унифицированные
   инструменты для их анализа.

 * Логи **не всегда информативны**. Например, в лог попала запись о том, что 
   всё сломалось, потому что это делается очевидно, но не попала запись о том,
   что оно починилось обратно. Или наоборот, в логи вываливается информация о
   каждом чихе системы, и проследить за конкретным параметром становится сложно
   (привет `wb-mqtt-serial`, который при включении debug начинает вываливать в
   логи содержимое посылок, когда нужно отследить что-то другое). Особенно 
   неприятно, когда проблема случается на продакшне при выключенном debug,
   из-за чего часть полезной информации исчезает бесследно.
   К тому же очень легко запутаться в бесконечных уровнях логирования (debug, 
   info, warning, error, а ещё добавить verbose и прочее).

 * По логу **сложно оценить, в каком состоянии система**. Нельзя быстро
   взглянуть на лог и сказать, что у нас всё хорошо или надо срочно что-то
   делать. Для этого нужно потратить минуту на то, чтобы натравить на лог
   анализатор (хотя бы в виде грепа или даже скрипта). Когда это нужно сделать
   для нескольких контроллеров - становится некомфортно. А в некоторых случаях
   логи могут оказаться заваленными одинаковыми записями и часть информации
   сотрётся из-за log rotation.

 * Логи в обычном виде - **не источник событий**. Конечно, можно написать
   скрипт, который будет отсылать сообщение на почту при появлении в логах
   подозрительных записей, но это сложно для начинающих пользователей, да и
   у опытных пользователей может вызвать фрустрацию.


Отдельно хочу отметить проблемы с логами именно для Wiren Board:

 * **Нет удобного интерфейса пользователя**. За логами приходится лазить
   в консоль. Это неудобно для неопытных пользователей и доставляет проблемы
   опытным, потому что требуется много действий. Нужно решение, которое будет
   работать из web-интерфейса, не будет потреблять слишком много трафика и
   будет позволять быстро извлекать всю необходимую информацию о системе
   (возможно, вплоть до версий ПО, чтобы можно было сделать пост на форум
   условным нажатием одной кнопки). Также нужен простой и эффективный механизм
   фильтрации логов.

 * Выводом логов **сложно управлять** (в текущей конфигурации Wiren Board).
   Есть режим "нормальная работа", когда логи сыпятся скудно, и режим "debug",
   когда при должной загрузке системы перестаёт хватать пропускной способности
   канала для того, чтобы выгружать лог "на лету".

 * **Нет API для выгрузки** логов. (*Необходимость такого API для меня
   только предположение, приглашаю коллег принять участие в дискуссии по этому
   поводу*). Может быть полезным для обслуживания больших систем с множеством
   контроллеров, дополнительный и почти бесплатный источник информации для
   мониторинга состояния всей системы и быстрого выявления неисправностей.


Предлагаемое решение
--------------------

Исходя из всего вышесказанного, хочется предложить инструмент, который будет
решать перечисленные проблемы, при этом сохраняя сильные стороны логов.

Источником вдохновения послужили диагностики из Robot Operating System
(см. [ROS diagnostics (en)](https://wiki.ros.org/diagnostics)).

Новый инструментарий для логирования и диагностики должен уметь следующее:


### Категории

Все записи в лог помечаются именем категории. Это нужно для того, чтобы
получить возможность быстро выбрать из лога только те записи, которые относятся
к конкретному компоненту или подсистеме.

Категории складываются в древовидную иерархию. На примере `wb-mqtt-serial`, 
это позволяет выбрать как записи для отдельного устройства, так и для
всех устройств на конкретной шине.


### Диагностики
 
Это аналог "контрольных ламп" для параметров.
   
В каждый момент времени для каждой диагностики можно получить её актуальное
состояние:

 - `ok`, когда всё хорошо,
 - `warn`, когда есть незначительные проблемы, на которые стоит обратить
   внимание, не влияющие на функционирование системы;
 - `error`, когда есть проблема, требующая вмешательства.

Состояние сопровождается текстовым описанием, временной меткой (последнее
обновление), а также дополнительными полями при необходимости.

Древовидная иерархия позволяет использовать диагностики для быстрой оценки
состояния системы. Если внутри категории все диагностики находятся в состоянии
`ok`, категории также присваивается состояние `ok`. Если же внутри есть
диагностики в ошибочном состоянии, категория получает особое состояние `mixed`
(если присутствуют и ошибочные, и нормальные состояния), или ошибочное
состояние.

Также для диагностики (или дерева диагностик) возможно состояние `n/a`,
когда демон, формирующий диагностики, недоступен (от англ. not available).

Пример диагностик на примере устройств в `wb-mqtt-serial`:

| Категория                    | Статус | Сообщение                           |
|------------------------------|--------|-------------------------------------|
| /serial/bus1/dev1/status     | ok     | Device is online, config is valid   |
| /serial/bus1/dev1/pollrate   | warn   | Actual 25.3 Hz, expected 40 Hz      |
| /serial/bus1/dev2/status     | error  | Device is not responding            |
| /serial/bus2/dev1/status     | ok     | Device is online, config is valid   |
| /serial/bus2/dev1/pollrate   | ok     | Actual 48.2 Hz, expected 50 Hz      |
| /homa-gpio                   | n/a    | Service is disabled                 |

Для приведённого примера можно построить дерево категорий и присвоить каждой
категории свой статус:

```
+----------------------------------+
| Категория               | Статус |
|-------------------------|--------|
| serial                  | mixed  |
| +-bus1                  | mixed  |
| | +-dev1                | mixed  |
| | | +-status            | ok     |
| | | +-pollrate          | warn   |
| | +-dev2                | error  |
| |   +-status            | error  |
| +-bus2                  | ok     |
|   +-dev1                | ok     |
|     +-status            | ok     |
|     +-pollrate          | ok     |
| homa-gpio               | n/a    |
+----------------------------------+
```

Если свернуть это дерево, можно увидеть, что в сервисе `serial` на шине `bus1`
есть проблемы, а шина `bus2` в состоянии `ok`. Таким образом, диагностики
позволяют быстро оценить общее состояние системы, рассматривая детали только
при необходимости.

Диагностики реализуются на основе обычных записей в лог, таким образом,
появляется возможность отследить изменение состояния конкрентых диагностик
во времени.

В реализации диагностики отличаются от обычных записей в лог тем, что
информацию о каждой диагностике нужно поддерживать актуальной, начиная с
момента запуска сервиса и в течение всей его жизни. Для этого для диагностик
будет представлено специальное API, с помощью которого это будет происходить
удобно для программиста.


Размышления на тему
-------------------

> От автора: изначально планировалось разрабатывать только инструментарий
> диагностик и со временем сделать так, чтобы одних диагностик было достаточно
> для разбора полётов в большинстве решаемых проблем. Это означает отказ от
> логов как способа сообщить о проблемах в системе. Логи можно оставить
> исключительно как инструмент для программиста.
> 
> Таким образом, у пользователя остаётся один хорошо структурированный и 
> развиваемый инструмент, с помощью которого можно разобраться с проблемами
> в системе. Диагностики можно было бы выводить в виде виджетов, собирать
> на мониторингах (например, в Grafana); историю событий диагностик в
> отдельной категории можно отправлять вместо обычного лога
> в техподдержку или на форум. Древовидная иерархия позволяет избегать
> перерасхода трафика, если запрашивать расширенную информацию только при
> обнаружении проблемы в отдельных категориях.
>
> Если API диагностик будет не существенно сложнее обычной записи в лог,
> это будет сподвигать программиста на их частое использование, что
> будет увеличивать качество выдаваемой информации по сравнению с обычными
> логами, а также приводить к унификации вывода отладочной информации между
> разными демонами в системе.
>
> Но есть то, что диагностики не умеют делать - это обрабатывать записи о
> событиях (когда смена состояния не имеет значения).
> Например, отправка сообщения в шину может сопровождаться записью в лог,
> но в виде диагностики не представима.
>
> В итоге получается, что нужны и обычные логи, и диагностики. Хорошая новость
> заключается в том, что диагностики - это тоже в каком-то смысле логи
> (каждое изменение состояния диагностики - это запись в лог с дополнительной
> информацией), и диагностики с событиями можно сложить в один файл, который
> потом легко распарсить.


Детали реализации
=================

**Раздел в процессе формирования**

Тезисно:

 * systemd/journald в качестве бекенда (потому что уже есть, и там есть 
   возможность добавлять метаинформацию к записям. TODO: исследовать
   возможность journald по фильтрации записей);
 
 * унифицированное API для C++/Go/JS (в wb-rules);

 * демо web-интерфейса для диагностик в процессе, постараюсь скоро выложить.
